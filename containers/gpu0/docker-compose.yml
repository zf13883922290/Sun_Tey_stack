# ╔══════════════════════════════════════════════════════════╗
# ║  GPU 0 容器 — 推理栈                                    ║
# ║                                                        ║
# ║  服务：                                                ║
# ║    nim          NVIDIA NIM 推理 API       :8000        ║
# ║    nemo_agent   NeMo Agent Toolkit MCP   :9000        ║
# ║    chromadb     向量记忆数据库             :8001        ║
# ║                                                        ║
# ║  GPU：绑定到 GPU_UUID_0（推理专用，不被训练占用）        ║
# ╚══════════════════════════════════════════════════════════╝


services:

  # ── NVIDIA NIM 推理微服务 ─────────────────────────────────────────────────
  nim:
    image: nvcr.io/nim/meta/llama-3.1-8b-instruct:latest
    container_name: sun_tey_nim
    restart: unless-stopped
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=${GPU_UUID_0}          # 严格绑定 GPU 0 UUID
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - NGC_API_KEY=${NGC_API_KEY}
      - NIM_MAX_MODEL_LEN=8192
      - NIM_GPU_MEMORY_UTILIZATION=0.85
    ports:
      - "8000:8000"
    volumes:
      - nim_cache:/opt/nim/.cache                     # 模型缓存，避免重复下载
    networks:
      - gpu0_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/v1/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s    # NIM 首次启动需要时间编译优化
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["${GPU_UUID_0}"]
              capabilities: [gpu]

  # ── NeMo Agent Toolkit as MCP Server ──────────────────────────────────────
  nemo_agent:
    image: nvcr.io/nvidia/nemo:24.07
    container_name: sun_tey_mcp
    restart: unless-stopped
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=${GPU_UUID_0}
      - CHROMA_HOST=chromadb
      - CHROMA_PORT=8000
      - NIM_BASE_URL=http://nim:8000/v1
      - NIM_MODEL=${NIM_MODEL:-meta/llama-3.1-8b-instruct}
    ports:
      - "9000:9000"                                   # MCP Server 端口
    volumes:
      - ../../configs:/configs:ro
      - ./nemo_mcp_server.py:/app/nemo_mcp_server.py  # MCP 工具定义
    command: ["python", "/app/nemo_mcp_server.py"]
    depends_on:
      chromadb:
        condition: service_healthy
      nim:
        condition: service_healthy
    networks:
      - gpu0_net

  # ── ChromaDB 向量记忆数据库 ───────────────────────────────────────────────
  chromadb:
    image: chromadb/chroma:latest
    container_name: sun_tey_chromadb
    restart: unless-stopped
    ports:
      - "8001:8000"
    volumes:
      - chroma_data:/chroma/.chroma/index
    networks:
      - gpu0_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v2/heartbeat"]
      interval: 15s
      timeout: 5s
      retries: 3

# ── 持久化卷 ──────────────────────────────────────────────────────────────────
volumes:
  nim_cache:          # NIM 模型缓存（模型权重 + TensorRT 编译结果）
  chroma_data:        # 向量记忆数据

# ── 网络（GPU 0 内部通信）─────────────────────────────────────────────────────
networks:
  gpu0_net:
    driver: bridge
